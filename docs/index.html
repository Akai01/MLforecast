---

title: mlforecast


keywords: fastai
sidebar: home_sidebar

summary: "Scalable machine learning based time series forecasting."
description: "Scalable machine learning based time series forecasting."
nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install mlforecast</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Optional-dependencies">Optional dependencies<a class="anchor-link" href="#Optional-dependencies"> </a></h3><p>If you want more functionality you can instead use <code>pip install mlforecast[extra1, extra2, ...]</code>. The current extra dependencies are:</p>
<ul>
<li><strong>aws</strong>: adds the functionality to use S3 as the storage in the CLI.</li>
<li><strong>cli</strong>: includes the validations necessary to use the CLI.</li>
<li><strong>distributed</strong>: installs <code>dask</code> to perform distributed training. Note that you'll also need to install either <code>lightgbm</code> or <code>xgboost</code>.</li>
</ul>
<p>For example, if you want to perform distributed training through the CLI using S3 as your storage you'll need all three extras, which you can get using: <code>pip install mlforecast[aws, cli, distributed]</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Programmatic-API">Programmatic API<a class="anchor-link" href="#Programmatic-API"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Store your time series in a pandas dataframe with an index named <strong>unique_id</strong> that is the identifier of each serie, a column <strong>ds</strong> that contains the datestamps and a column <strong>y</strong> with the values.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mlforecast.utils</span> <span class="kn">import</span> <span class="n">generate_daily_series</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_daily_series</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">display_df</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<table>
<thead><tr>
<th style="text-align:left">unique_id</th>
<th style="text-align:left">ds</th>
<th style="text-align:right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-01-01 00:00:00</td>
<td style="text-align:right">0.264447</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-01-02 00:00:00</td>
<td style="text-align:right">1.28402</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-01-03 00:00:00</td>
<td style="text-align:right">2.4628</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-01-04 00:00:00</td>
<td style="text-align:right">3.03552</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-01-05 00:00:00</td>
<td style="text-align:right">4.04356</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then you define your flow configuration. These include lags, transformations on the lags and date features. The transformations are defined as <code>numba</code> jitted functions that transform an array. If they have additional arguments you supply a tuple (<code>transform_func</code>, <code>arg1</code>, <code>arg2</code>, ...)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">window_ops.expanding</span> <span class="kn">import</span> <span class="n">expanding_mean</span>
<span class="kn">from</span> <span class="nn">window_ops.rolling</span> <span class="kn">import</span> <span class="n">rolling_mean</span>

<span class="n">flow_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
    <span class="n">lag_transforms</span><span class="o">=</span><span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="n">expanding_mean</span><span class="p">],</span>
        <span class="mi">7</span><span class="p">:</span> <span class="p">[(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">14</span><span class="p">)]</span>
    <span class="p">},</span>
    <span class="n">date_features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dayofweek&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next define a model, if you're on a single machine this can be any regressor that follows the scikit-learn API. For distributed training there are <a href="/mlforecast/distributed.models.lgb.html#LGBMForecast"><code>LGBMForecast</code></a> and <a href="/mlforecast/distributed.models.xgb.html#XGBForecast"><code>XGBForecast</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now instantiate your forecast object with the model and the flow configuration. There are two types of forecasters, <a href="/mlforecast/forecast.html#Forecast"><code>Forecast</code></a> and <a href="/mlforecast/distributed.forecast.html#DistributedForecast"><code>DistributedForecast</code></a>. Since this is a single machine example we'll use the first.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mlforecast.forecast</span> <span class="kn">import</span> <span class="n">Forecast</span>

<span class="n">fcst</span> <span class="o">=</span> <span class="n">Forecast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">flow_config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To compute the transformations and train the model on the data you call <code>.fit</code> on your <a href="/mlforecast/forecast.html#Forecast"><code>Forecast</code></a> object.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fcst</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Forecast(model=RandomForestRegressor(), flow_config={&#39;lags&#39;: [7, 14], &#39;lag_transforms&#39;: {1: [CPUDispatcher(&lt;function expanding_mean at 0x7fac9f73f280&gt;)], 7: [(CPUDispatcher(&lt;function rolling_mean at 0x7fac9f7a8f70&gt;), 7), (CPUDispatcher(&lt;function rolling_mean at 0x7fac9f7a8f70&gt;), 14)]}, &#39;date_features&#39;: [&#39;dayofweek&#39;, &#39;month&#39;]})</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To get the forecasts for the next 14 days you just call <code>.predict(14)</code> on the forecaster.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>

<span class="n">display_df</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<table>
<thead><tr>
<th style="text-align:left">unique_id</th>
<th style="text-align:left">ds</th>
<th style="text-align:right">y_pred</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-08-10 00:00:00</td>
<td style="text-align:right">5.2325</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-08-11 00:00:00</td>
<td style="text-align:right">6.26395</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-08-12 00:00:00</td>
<td style="text-align:right">0.196386</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-08-13 00:00:00</td>
<td style="text-align:right">1.25263</td>
</tr>
<tr>
<td style="text-align:left">id_00</td>
<td style="text-align:left">2000-08-14 00:00:00</td>
<td style="text-align:right">2.2988</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="CLI">CLI<a class="anchor-link" href="#CLI"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're looking for computing quick baselines, want to avoid some boilerplate or just like using CLIs better then you can use the <code>mlforecast</code> binary with a configuration file like the following:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>cat sample_configs/local.yaml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>data:
  prefix: data
  input: train
  output: outputs
  format: parquet
features:
  freq: D
  lags: [7, 14]
  lag_transforms:
    1: 
    - expanding_mean
    7: 
    - rolling_mean:
        window_size: 7
    - rolling_min:
        window_size: 7
  date_features: [&#34;dayofweek&#34;, &#34;month&#34;, &#34;year&#34;]
  num_threads: 2
backtest:
  n_windows: 2
  window_size: 7
forecast:
  horizon: 7
local:
  model:
    name: sklearn.ensemble.RandomForestRegressor
    params:
      n_estimators: 10
      max_depth: 7
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This will use the data in <code>prefix/input</code> and write the results to <code>prefix/output</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>mlforecast sample_configs/local.yaml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Split 1 MSE: 0.0240
Split 2 MSE: 0.0187
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls data/outputs/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>forecast.parquet  valid_0.parquet  valid_1.parquet
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

